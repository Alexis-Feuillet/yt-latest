<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Latest YouTube Player</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
    }

    .wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
    }

    iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
  </style>
</head>

<body>

  <div class="wrap" id="wrap"></div>

  <script>
    const LATEST_JSON =
      "https://alexis-feuillet.github.io/yt-latest/latest.json";

    const REFRESH_MS = 30 * 60 * 1000;

    let currentVideoId = null;

    function extractVideoId(url) {
      if (!url) return null;

      const s = String(url).trim();

      if (/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;

      let m =
        s.match(/[?&]v=([a-zA-Z0-9_-]{11})/) ||
        s.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/) ||
        s.match(/\/embed\/([a-zA-Z0-9_-]{11})/);

      return m ? m[1] : null;
    }

    function render(videoId) {
      const embed =
        `https://www.youtube.com/embed/${videoId}`;

      document.getElementById("wrap").innerHTML = `
        <iframe
          src="${embed}"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen>
        </iframe>`;
    }

    async function refresh() {
      try {
        const res = await fetch(
          LATEST_JSON + "?t=" + Date.now(),
          { cache: "no-store" }
        );

        const data = await res.json();

        const videoId =
          extractVideoId(data.url);

        if (!videoId) return;

        if (videoId === currentVideoId)
          return;

        currentVideoId = videoId;

        render(videoId);

      } catch (e) {
        console.error(
          "Erreur chargement latest.json",
          e
        );
      }
    }

    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>

</body>
</html>
