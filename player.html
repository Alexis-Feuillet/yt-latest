<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Latest YouTube Player</title>

  <style>
    html, body { margin: 0; padding: 0; background: transparent; }

    .wrap{
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      overflow: hidden;
    }

    /* Iframe YouTube (chargé en arrière-plan) */
    iframe{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      opacity: 0;                 /* invisible au début */
      transition: opacity .2s ease;
    }
    iframe.ready{ opacity: 1; }   /* devient visible quand prêt */

    /* Miniature affichée immédiatement */
    img.thumb{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border: 0;
      opacity: 1;
      transition: opacity .2s ease;
    }
    img.thumb.hide{ opacity: 0; pointer-events: none; }

    /* Overlay play discret pendant chargement */
    .playOverlay{
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
      transition: opacity .2s ease;
      opacity: 1;
    }
    .playOverlay.hide{ opacity: 0; }

    .playIcon{
      width: 64px;
      height: 64px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      display: grid;
      place-items: center;
      backdrop-filter: blur(2px);
    }
    .playIcon:before{
      content: "";
      display: block;
      margin-left: 4px;
      width: 0; height: 0;
      border-left: 18px solid #fff;
      border-top: 11px solid transparent;
      border-bottom: 11px solid transparent;
    }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <!-- On injecte tout en JS -->
  </div>

  <script>
    const LATEST_JSON = "https://alexis-feuillet.github.io/yt-latest/latest.json";
    const REFRESH_MS = 30 * 60 * 1000;

    // Mode privacy-enhanced + UI clean (ta config qui a viré pubs/overlays)
    const USE_NOCOOKIE = true;
    const EMBED_PARAMS = new URLSearchParams({
      rel: "0",
      modestbranding: "1",
      playsinline: "1"
    });

    let currentVideoId = null;

    function extractVideoId(url){
      if (!url) return null;
      const s = String(url).trim();
      if (/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;

      const m =
        s.match(/[?&]v=([a-zA-Z0-9_-]{11})/) ||
        s.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/) ||
        s.match(/\/embed\/([a-zA-Z0-9_-]{11})/);

      return m ? m[1] : null;
    }

    function buildEmbedUrl(videoId){
      const base = USE_NOCOOKIE
        ? "https://www.youtube-nocookie.com/embed/"
        : "https://www.youtube.com/embed/";
      return `${base}${videoId}?${EMBED_PARAMS.toString()}`;
    }

    // Miniature fiable (évite le placeholder gris de maxresdefault)
    function buildThumbUrl(videoId){
      return `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
    }

    function render(videoId){
      const wrap = document.getElementById("wrap");
      wrap.innerHTML = "";

      const img = document.createElement("img");
      img.className = "thumb";
      img.src = buildThumbUrl(videoId);
      img.alt = "Miniature vidéo YouTube";

      const overlay = document.createElement("div");
      overlay.className = "playOverlay";
      overlay.innerHTML = `<div class="playIcon"></div>`;

      const iframe = document.createElement("iframe");
      iframe.src = buildEmbedUrl(videoId);
      iframe.allow = "accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
      iframe.allowFullscreen = true;

      // IMPORTANT: on append l’iframe tout de suite -> il charge réellement
      wrap.appendChild(iframe);
      wrap.appendChild(img);
      wrap.appendChild(overlay);

      // Quand prêt, on révèle la vidéo et on masque la miniature
      iframe.addEventListener("load", () => {
        iframe.classList.add("ready");
        img.classList.add("hide");
        overlay.classList.add("hide");
      });

      // Sécurité: si le load tarde, on force l’affichage après 2.5s
      setTimeout(() => {
        iframe.classList.add("ready");
        img.classList.add("hide");
        overlay.classList.add("hide");
      }, 2500);
    }

    async function refresh(){
      try{
        const res = await fetch(LATEST_JSON + "?t=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        const videoId = extractVideoId(data.url);
        if (!videoId) return;

        if (videoId === currentVideoId) return;
        currentVideoId = videoId;

        render(videoId);
      }catch(e){
        console.error("Erreur latest.json:", e);
      }
    }

    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
