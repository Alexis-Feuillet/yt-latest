<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Latest YouTube Player</title>
  <style>
    html, body { margin:0; padding:0; background:transparent; }
    .wrap{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
      border-radius:12px;
      overflow:hidden;
    }
    iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
    }
    .fallback{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      color:#fff;
      font-family:Arial, sans-serif;
      font-size:14px;
      text-align:center;
      background:#000;
    }
    .fallback a{ color:#fff; text-decoration:underline; }
  </style>
</head>

<body>
  <div class="wrap" id="wrap">
    <div class="fallback" id="msg">Chargement de la dernière vidéo…</div>
  </div>

  <script>
    // ✅ Ton JSON GitHub Pages
    const LATEST_JSON = "https://alexis-feuillet.github.io/yt-latest/latest.json";

    // ✅ Refresh automatique (30 min)
    const REFRESH_MS = 30 * 60 * 1000;

    let currentVideoId = null;

    function extractVideoId(url) {
      if (!url) return null;
      const s = String(url).trim();

      // ID direct (11 chars)
      if (/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;

      // watch?v=ID
      let m = s.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
      if (m) return m[1];

      // youtu.be/ID
      m = s.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
      if (m) return m[1];

      // /embed/ID
      m = s.match(/\/embed\/([a-zA-Z0-9_-]{11})/);
      if (m) return m[1];

      return null;
    }

    function setMessage(html) {
      document.getElementById("wrap").innerHTML =
        `<div class="fallback" id="msg">${html}</div>`;
    }

    function renderPlayer(videoId) {
      const embed = `https://www.youtube.com/embed/${videoId}`;
      document.getElementById("wrap").innerHTML = `
        <iframe
          src="${embed}"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen>
        </iframe>`;
    }

    async function refresh() {
      try {
        const res = await fetch(LATEST_JSON + "?t=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const url = data.url;
        const videoId = extractVideoId(url);

        if (!videoId) {
          setMessage(`❌ URL invalide dans latest.json<br><a href="${LATEST_JSON}" target="_blank">Voir latest.json</a>`);
          return;
        }

        // Si la vidéo n'a pas changé, on ne touche à rien (ça évite de relancer le player)
        if (videoId === currentVideoId) return;

        currentVideoId = videoId;
        renderPlayer(videoId);

      } catch (e) {
        setMessage(`❌ Impossible de charger la dernière vidéo.<br>
          <a href="${LATEST_JSON}" target="_blank">Ouvrir latest.json</a>`);
      }
    }

    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
