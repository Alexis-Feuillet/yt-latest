name: Update latest YouTube URL

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download JSON from Apps Script
        run: |
          set -e
          APPS_SCRIPT_URL="https://script.google.com/macros/s/AKfycbwir5H8_B9BmSouM26WWoh9sxTIQGy8tU8ZfWM7mVZT8aFWuQq8vilmweyh83IxBYx_eQ/exec"
          echo "Downloading from: $APPS_SCRIPT_URL"
          curl -LfsS "$APPS_SCRIPT_URL" -o _raw.json
          echo "Downloaded bytes:"
          wc -c _raw.json

      - name: Validate + build minimal latest.json
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const raw = fs.readFileSync('_raw.json', 'utf8');
          const data = JSON.parse(raw);

          // On prend en priorité watchUrl, sinon on tente embedUrl, sinon videoId
          let url = data.watchUrl || data.url || null;

          if (!url && data.embedUrl) {
            // Convertit embedUrl -> watchUrl (optionnel, mais plus "Systeme.io friendly")
            const m = String(data.embedUrl).match(/\/embed\/([a-zA-Z0-9_-]{11})/);
            if (m) url = `https://www.youtube.com/watch?v=${m[1]}`;
          }

          if (!url && data.videoId) {
            url = `https://www.youtube.com/watch?v=${data.videoId}`;
          }

          if (!url) {
            console.error('❌ Impossible de trouver watchUrl/embedUrl/videoId dans la réponse Apps Script');
            process.exit(1);
          }

          const minimal = {
            ok: true,
            url,
            updatedAt: new Date().toISOString()
          };

          fs.writeFileSync('latest.json', JSON.stringify(minimal, null, 2));
          console.log('✅ latest.json written:', minimal);
          NODE

      - name: Commit and push (always)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add latest.json
          git commit -m "Auto update latest.json (url)" || echo "Nothing to commit"
          git push
